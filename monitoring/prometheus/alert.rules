groups:
  - name: App
    rules:
      - alert: TooManyRequests
        expr: 'sum(increase(app_requests_total{path!~"csp_reports",status=~"429"}[1m])) > 0'
        labels:
          severity: high
        annotations:
          summary: Alerts when any user hits a rate limit, excluding the /csp_reports endpoint.
          description: Alerts when any user hits a rate limit, excluding the /csp_reports endpoint.
          runbook: https://dfedigital.atlassian.net/wiki/spaces/GGIT/pages/2156036281/App+TTA+Runbook#TooManyRequests-HIGH
          dashboard: https://grafana-prod-get-into-teaching.london.cloudapps.digital/d/0PRnzc2Mk/get-into-teaching-apps?viewPanel=27&orgId=1
      - alert: HighNotFound
        expr: 'sum(increase(app_requests_total{path=~".+",status=~"404"}[10m])) > 15'
        labels:
          severity: medium
        annotations:
          summary: Alerts when the app is serving a high number of 404 responses (more than 15 in any 10 minute period).
          description: Alerts when the app is serving a high number of 404 responses (more than 15 in any 10 minute period).
          runbook: https://dfedigital.atlassian.net/wiki/spaces/GGIT/pages/2156036281/App+TTA+Runbook#HighNotFound-MEDIUM
          dashboard: https://grafana-prod-get-into-teaching.london.cloudapps.digital/d/0PRnzc2Mk/get-into-teaching-apps?viewPanel=27&orgId=1
      - alert: HighCpu
        expr: 'max(cpu{app="get-into-teaching-app-prod"}) > 70'
        labels:
          severity: medium
        annotations:
          summary: Alerts when any of the app instances exceed 70% CPU utilisation.
          description: Alerts when any of the app instances exceed 70% CPU utilisation.
          runbook: https://dfedigital.atlassian.net/wiki/spaces/GGIT/pages/2156036281/App+TTA+Runbook#HighCpu-MEDIUM
          dashboard: https://grafana-prod-get-into-teaching.london.cloudapps.digital/d/0PRnzc2Mk/get-into-teaching-apps?viewPanel=31&orgId=1
      - alert: HighMemory
        expr: 'max(memory_utilization{app="get-into-teaching-app-prod"}) > 70'
        labels:
          severity: medium
        annotations:
          summary: Alerts when any of the app instances exceed 70% memory utilisation.
          description: Alerts when any of the app instances exceed 70% memory utilisation.
          runbook: https://dfedigital.atlassian.net/wiki/spaces/GGIT/pages/2156036281/App+TTA+Runbook#HighMemory-MEDIUM
          dashboard: https://grafana-prod-get-into-teaching.london.cloudapps.digital/d/0PRnzc2Mk/get-into-teaching-apps?viewPanel=33&orgId=1
  - name: TTA
    rules:
      - alert: TooManyRequests
        expr: 'sum(increase(tta_requests_total{path!~"csp_reports",status=~"429"}[1m])) > 0'
        labels:
          severity: high
        annotations:
          summary: Alerts when any user hits a rate limit, excluding the /csp_reports endpoint.
          description: Alerts when any user hits a rate limit, excluding the /csp_reports endpoint.
          runbook: https://dfedigital.atlassian.net/wiki/spaces/GGIT/pages/2156036281/App+TTA+Runbook#TooManyRequests-HIGH
          dashboard: https://grafana-prod-get-into-teaching.london.cloudapps.digital/d/0PRnzc2Mk/get-into-teaching-apps?viewPanel=27&orgId=1
      - alert: HighNotFound
        expr: 'sum(increase(tta_requests_total{path=~".+",status=~"404"}[10m])) > 15'
        labels:
          severity: medium
        annotations:
          summary: Alerts when the app is serving a high number of 404 responses (more than 15 in any 10 minute period).
          description: Alerts when the app is serving a high number of 404 responses (more than 15 in any 10 minute period).
          runbook: https://dfedigital.atlassian.net/wiki/spaces/GGIT/pages/2156036281/App+TTA+Runbook#HighNotFound-MEDIUM
          dashboard: https://grafana-prod-get-into-teaching.london.cloudapps.digital/d/0PRnzc2Mk/get-into-teaching-apps?viewPanel=27&orgId=1 
      - alert: HighCpu
        expr: 'max(cpu{app="get-teacher-training-adviser-service-prod"}) > 70'
        labels:
          severity: medium
        annotations:
          summary: Alerts when any of the app instances exceed 70% CPU utilisation.
          description: Alerts when any of the app instances exceed 70% CPU utilisation.
          runbook: https://dfedigital.atlassian.net/wiki/spaces/GGIT/pages/2156036281/App+TTA+Runbook#HighCpu-MEDIUM
          dashboard: https://grafana-prod-get-into-teaching.london.cloudapps.digital/d/0PRnzc2Mk/get-into-teaching-apps?viewPanel=31&orgId=1
      - alert: HighMemory
        expr: 'max(memory_utilization{app="get-teacher-training-adviser-service-prod"}) > 70'
        labels:
          severity: medium
        annotations:
          summary: Alerts when any of the app instances exceed 70% memory utilisation.
          description: Alerts when any of the app instances exceed 70% memory utilisation.
          runbook: https://dfedigital.atlassian.net/wiki/spaces/GGIT/pages/2156036281/App+TTA+Runbook#HighMemory-MEDIUM
          dashboard: https://grafana-prod-get-into-teaching.london.cloudapps.digital/d/0PRnzc2Mk/get-into-teaching-apps?viewPanel=33&orgId=1
  - name: API
    rules:
      - alert: TooManyRequests
        expr: >-
          sum(increase(http_requests_received_total{controller=~".+",action=~".+",code=~"429"}[1m]))
          > 0
        labels:
          severity: medium
        annotations:
          summary: Alert when any client hits a rate limit.
          runbook: https://dfedigital.atlassian.net/wiki/spaces/GGIT/pages/2152497153/Rate+Limit
          dashboard: https://grafana-prod-get-into-teaching.london.cloudapps.digital/d/28EURzZGz/get-into-teaching-api?viewPanel=60&orgId=1&var-App=get-into-teaching-api-prod
          description: The API has recieved too many requests,  please read the runbook for advice on what action should be taken.
      - alert: FailedJobs
        expr: 'sum(increase(api_hangfire_jobs{state="failed"}[1m])) > 0'
        labels:
          severity: high
        annotations:
          summary: Alert when any job fails.
      - alert: HighGoogleApiCalls
        expr: 'sum(increase(api_google_api_calls[10m])) > 5'
        labels:
          severity: high
        annotations:
          summary: Alert when a high number of Google API calls are made (>5 in a 10m period).
      - alert: GoogleApiErrors
        expr: 'sum(rate(api_google_api_calls{result != "success"}[1m])) > 0'
        labels:
          severity: medium
        annotations:
          summary: Alert when the Google API returns a non-success response.
      - alert: ClientApproachingRateLimit
        expr: 'max(increase(http_request_duration_seconds_sum{controller=~"Candidates|MailingList|TeachingEvents",action=~"AddMember|AddAttendee|SignUp",code=~".+"}[1m])) by (controller, action) > 50'
        labels:
          severity: medium
        annotations:
          summary: Alert when a client is approaching the rate limit threshold (50rpm out of an available 100rpm).
      - alert: ClientApproachingRateLimit (CreateAccessToken)
        expr: 'max(increase(http_request_duration_seconds_sum{controller=~"Candidates",action=~"CreateAccessToken",code=~".+"}[1m])) by (controller, action) > 175'
        labels:
          severity: medium
        annotations:
          summary: Alert when a client is approaching the rate limit threshold (175rpm out of an available 250rpm).
      - alert: HighCpu
        expr: 'max(cpu_percent) > 70'
        labels:
          severity: medium
        annotations:
          summary: Alert when max CPU utilization is over 70%.
      - alert: HighMemory
        expr: 'dotnet_total_memory_bytes > 768000000'
        labels:
          severity: medium
        annotations:
          summary: Alert when max memory utilization is over 768MB.
      - alert: HighDatabaseConnections
        expr: 'max(connections) > 75'
        labels:
          severity: medium
        annotations:
          summary: Alert when max database connections exceeds 75 (out of an available 100).
          
          
