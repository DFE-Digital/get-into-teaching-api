groups:
  - name: App
    rules:
      - alert: TooManyRequests
        expr: 'sum(increase(app_requests_total{path!~"csp_reports",status=~"429"}[1m])) > 0'
        labels:
          severity: high
        annotations:
          summary: Alert when any user hits a rate limit (excluding the /csp_reports endpoint).
      - alert: HighNotFound
        expr: 'sum(increase(app_requests_total{path=~".+",status=~"404"}[10m])) > 15'
        labels:
          severity: medium
        annotations:
          summary: Alert when a high number of 404 response codes are returned (>15 in a 10m period).
      - alert: HighCpu
        expr: 'max(cpu{app="get-into-teaching-app-prod"}) > 70'
        labels:
          severity: medium
        annotations:
          summary: Alert when max CPU utilization is over 70%.
      - alert: HighMemory
        expr: 'max(memory_utilization{app="get-into-teaching-app-prod"}) > 70'
        labels:
          severity: medium
        annotations:
          summary: Alert when memory utilization is over 70%.
  - name: TTA
    rules:
      - alert: TooManyRequests
        expr: 'sum(increase(tta_requests_total{path!~"csp_reports",status=~"429"}[1m])) > 0'
        labels:
          severity: high
        annotations:
          summary: Alert when any user hits a rate limit (excluding the /csp_reports endpoint).
      - alert: HighNotFound
        expr: 'sum(increase(tta_requests_total{path=~".+",status=~"404"}[10m])) > 15'
        labels:
          severity: medium
        annotations:
          summary: Alert when a high number of 404 response codes are returned (>15 in a 10m period).
      - alert: HighCpu
        expr: 'max(cpu{app="get-teacher-training-adviser-service-prod"}) > 70'
        labels:
          severity: medium
        annotations:
          summary: Alert when max CPU utilization is over 70%.
      - alert: HighMemory
        expr: 'max(memory_utilization{app="get-teacher-training-adviser-service-prod"}) > 70'
        labels:
          severity: medium
        annotations:
          summary: Alert when memory utilization is over 70%.
  - name: API
    rules:
      - alert: TooManyRequests
        expr: >-
          sum(increase(http_requests_received_total{controller=~".+",action=~".+",code=~"429"}[1m]))
          > 0
        labels:
          severity: medium
        annotations:
          summary: Alert when any client hits a rate limit.
          runbook: https://dfedigital.atlassian.net/wiki/spaces/GGIT/pages/2152497153/Rate+Limit
          dashboard: https://grafana-prod-get-into-teaching.london.cloudapps.digital/d/28EURzZGz/get-into-teaching-api?viewPanel=60&orgId=1&var-App=get-into-teaching-api-prod
          description: The API has recieved too many requests,  please read the runbook for advice on what action should be taken.
      - alert: FailedJobs
        expr: 'sum(increase(api_hangfire_jobs{state="failed"}[1m])) > 0'
        labels:
          severity: high
        annotations:
          summary: Alert when any job fails.
      - alert: HighGoogleApiCalls
        expr: 'sum(increase(api_google_api_calls[10m])) > 5'
        labels:
          severity: high
        annotations:
          summary: Alert when a high number of Google API calls are made (>5 in a 10m period).
      - alert: GoogleApiErrors
        expr: 'sum(rate(api_google_api_calls{result != "success"}[1m])) > 0'
        labels:
          severity: medium
        annotations:
          summary: Alert when the Google API returns a non-success response.
      - alert: ClientApproachingRateLimit
        expr: 'sum(increase(http_request_duration_seconds_sum{controller=~"Candidates|MailingList|TeachingEvents",action=~"CreateAccessToken|AddMember|AddAttendee|SignUp",code=~".+"}[1m])) by (controller, action) > 30'
        labels:
          severity: medium
        annotations:
          summary: Alert when a client is approaching the rate limit threshold (30rpm out of an available 60rpm).
      - alert: HighCpu
        expr: 'max(cpu_percent) > 70'
        labels:
          severity: medium
        annotations:
          summary: Alert when max CPU utilization is over 70%.
      - alert: HighMemory
        expr: 'dotnet_total_memory_bytes > 768000000'
        labels:
          severity: medium
        annotations:
          summary: Alert when max memory utilization is over 768MB.
      - alert: HighDatabaseConnections
        expr: 'max(connections) > 75'
        labels:
          severity: medium
        annotations:
          summary: Alert when max database connections exceeds 75 (out of an available 100).
          
          
